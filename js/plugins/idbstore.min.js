(function(e,t,r){if(typeof define==="function"){define(t)}else if(typeof module!=="undefined"&&module.exports){module.exports=t()}else{r[e]=t()}})("IDBStore",function(){"use strict";var e={storeName:"Store",storePrefix:"IDBWrapper-",dbVersion:1,keyPath:"id",autoIncrement:true,onStoreReady:function(){},onError:function(e){throw e},indexes:[]};var t=function(t,r){for(var n in e){this[n]=typeof t[n]!="undefined"?t[n]:e[n]}this.dbName=this.storePrefix+this.storeName;this.dbVersion=parseInt(this.dbVersion,10);r&&(this.onStoreReady=r);this.idb=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB;this.keyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.mozIDBKeyRange;this.consts={READ_ONLY:"readonly",READ_WRITE:"readwrite",VERSION_CHANGE:"versionchange",NEXT:"next",NEXT_NO_DUPLICATE:"nextunique",PREV:"prev",PREV_NO_DUPLICATE:"prevunique"};this.openDB()};t.prototype={version:"1.0.0",db:null,dbName:null,dbVersion:null,store:null,storeName:null,keyPath:null,autoIncrement:null,indexes:null,features:null,onStoreReady:null,onError:null,_insertIdCount:0,openDB:function(){var e=this.features={};e.hasAutoIncrement=!window.mozIndexedDB;var t=this.idb.open(this.dbName,this.dbVersion);var r=false;t.onerror=function(e){var t=false;if("error"in e.target){t=e.target.error.name=="VersionError"}else if("errorCode"in e.target){t=e.target.errorCode==12}if(t){this.onError(new Error("The version number provided is lower than the existing one."))}else{this.onError(e)}}.bind(this);t.onsuccess=function(e){if(r){return}if(this.db){this.onStoreReady();return}this.db=e.target.result;if(typeof this.db.version=="string"){this.onError(new Error("The IndexedDB implementation in this browser is outdated. Please upgrade your browser."));return}if(!this.db.objectStoreNames.contains(this.storeName)){this.onError(new Error("Something is wrong with the IndexedDB implementation in this browser. Please upgrade your browser."));return}var t=this.db.transaction([this.storeName],this.consts.READ_ONLY);this.store=t.objectStore(this.storeName);this.indexes.forEach(function(e){var t=e.name;if(!t){r=true;this.onError(new Error("Cannot create index: No index name given."));return}this.normalizeIndexData(e);if(this.hasIndex(t)){var n=this.store.index(t);var o=this.indexComplies(n,e);if(!o){r=true;this.onError(new Error('Cannot modify index "'+t+'" for current version. Please bump version number to '+(this.dbVersion+1)+"."))}}else{r=true;this.onError(new Error('Cannot create new index "'+t+'" for current version. Please bump version number to '+(this.dbVersion+1)+"."))}},this);r||this.onStoreReady()}.bind(this);t.onupgradeneeded=function(e){this.db=e.target.result;if(this.db.objectStoreNames.contains(this.storeName)){this.store=e.target.transaction.objectStore(this.storeName)}else{this.store=this.db.createObjectStore(this.storeName,{keyPath:this.keyPath,autoIncrement:this.autoIncrement})}this.indexes.forEach(function(e){var t=e.name;if(!t){r=true;this.onError(new Error("Cannot create index: No index name given."))}this.normalizeIndexData(e);if(this.hasIndex(t)){var n=this.store.index(t);var o=this.indexComplies(n,e);if(!o){this.store.deleteIndex(t);this.store.createIndex(t,e.keyPath,{unique:e.unique,multiEntry:e.multiEntry})}}else{this.store.createIndex(t,e.keyPath,{unique:e.unique,multiEntry:e.multiEntry})}},this)}.bind(this)},deleteDatabase:function(){if(this.idb.deleteDatabase){this.idb.deleteDatabase(this.dbName)}},put:function(e,t,n){n||(n=function(e){console.error("Could not write data.",e)});t||(t=r);if(typeof e[this.keyPath]=="undefined"&&!this.features.hasAutoIncrement){e[this.keyPath]=this._getUID()}var o=this.db.transaction([this.storeName],this.consts.READ_WRITE);var i=o.objectStore(this.storeName).put(e);i.onsuccess=function(e){t(e.target.result)};i.onerror=n},get:function(e,t,n){n||(n=function(e){console.error("Could not read data.",e)});t||(t=r);var o=this.db.transaction([this.storeName],this.consts.READ_ONLY);var i=o.objectStore(this.storeName).get(e);i.onsuccess=function(e){t(e.target.result)};i.onerror=n},remove:function(e,t,n){n||(n=function(e){console.error("Could not remove data.",e)});t||(t=r);var o=this.db.transaction([this.storeName],this.consts.READ_WRITE);var i=o.objectStore(this.storeName)["delete"](e);i.onsuccess=function(e){t(e.target.result)};i.onerror=n},batch:function(e,t,n){n||(n=function(e){console.error("Could not apply batch.",e)});t||(t=r);if(Object.prototype.toString.call(e)!="[object Array]"){n(new Error("dataArray argument must be of type Array."))}var o=this.db.transaction([this.storeName],this.consts.READ_WRITE);var i=e.length;var s=false;e.forEach(function(e){var r=e.type;var a=e.key;var u=e.value;if(r=="remove"){var c=o.objectStore(this.storeName)["delete"](a);c.onsuccess=function(e){i--;if(i===0&&!s){s=true;t()}};c.onerror=function(e){o.abort();if(!s){s=true;n(e,r,a)}}}else if(r=="put"){if(typeof u[this.keyPath]=="undefined"&&!this.features.hasAutoIncrement){u[this.keyPath]=this._getUID()}var d=o.objectStore(this.storeName).put(u);d.onsuccess=function(e){i--;if(i===0&&!s){s=true;t()}};d.onerror=function(e){o.abort();if(!s){s=true;n(e,r,u)}}}},this)},getAll:function(e,t){t||(t=function(e){console.error("Could not read data.",e)});e||(e=r);var n=this.db.transaction([this.storeName],this.consts.READ_ONLY);var o=n.objectStore(this.storeName);if(o.getAll){var i=o.getAll();i.onsuccess=function(t){e(t.target.result)};i.onerror=t}else{this._getAllCursor(n,e,t)}},_getAllCursor:function(e,t,r){var n=[];var o=e.objectStore(this.storeName);var i=o.openCursor();i.onsuccess=function(e){var r=e.target.result;if(r){n.push(r.value);r["continue"]()}else{t(n)}};i.onError=r},clear:function(e,t){t||(t=function(e){console.error("Could not clear store.",e)});e||(e=r);var n=this.db.transaction([this.storeName],this.consts.READ_WRITE);var o=n.objectStore(this.storeName).clear();o.onsuccess=function(t){e(t.target.result)};o.onerror=t},_getUID:function(){return this._insertIdCount++ +Date.now()},getIndexList:function(){return this.store.indexNames},hasIndex:function(e){return this.store.indexNames.contains(e)},normalizeIndexData:function(e){e.keyPath=e.keyPath||e.name;e.unique=!!e.unique;e.multiEntry=!!e.multiEntry},indexComplies:function(e,t){var r=["keyPath","unique","multiEntry"].every(function(r){if(r=="multiEntry"&&e[r]===undefined&&t[r]===false){return true}return t[r]==e[r]});return r},iterate:function(e,t){t=o({index:null,order:"ASC",filterDuplicates:false,keyRange:null,writeAccess:false,onEnd:null,onError:function(e){console.error("Could not open cursor.",e)}},t||{});var r=t.order.toLowerCase()=="desc"?"PREV":"NEXT";if(t.filterDuplicates){r+="_NO_DUPLICATE"}var n=this.db.transaction([this.storeName],this.consts[t.writeAccess?"READ_WRITE":"READ_ONLY"]);var i=n.objectStore(this.storeName);if(t.index){i=i.index(t.index)}var s=i.openCursor(t.keyRange,this.consts[r]);s.onerror=t.onError;s.onsuccess=function(r){var o=r.target.result;if(o){e(o.value,o,n);o["continue"]()}else{if(t.onEnd){t.onEnd()}else{e(null)}}}},query:function(e,t){var r=[];t=t||{};t.onEnd=function(){e(r)};this.iterate(function(e){r.push(e)},t)},count:function(e,t){t=o({index:null,keyRange:null},t||{});var r=t.onError||function(e){console.error("Could not open cursor.",e)};var n=this.db.transaction([this.storeName],this.consts.READ_ONLY);var i=n.objectStore(this.storeName);if(t.index){i=i.index(t.index)}var s=i.count(t.keyRange);s.onsuccess=function(t){e(t.target.result)};s.onError=function(e){r(e)}},makeKeyRange:function(e){var t,r=typeof e.lower!="undefined",n=typeof e.upper!="undefined";switch(true){case r&&n:t=this.keyRange.bound(e.lower,e.upper,e.excludeLower,e.excludeUpper);break;case r:t=this.keyRange.lowerBound(e.lower,e.excludeLower);break;case n:t=this.keyRange.upperBound(e.upper,e.excludeUpper);break;default:throw new Error('Cannot create KeyRange. Provide one or both of "lower" or "upper" value.')}return t}};var r=function(){};var n={};var o=function(e,t){var r,o;for(r in t){o=t[r];if(o!==n[r]&&o!==e[r]){e[r]=o}}return e};t.version=t.prototype.version;return t},this);